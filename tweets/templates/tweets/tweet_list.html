{% extends 'base.html' %}

{% block title %}Tweets | {{ block.super }}{% endblock title %}

{% block content %}
    <div class="row">
        <div class="col-sm-3 col-xs-12">
            <h4>{{ request.user }}</h4>
        </div>
        <div class="col-sm-9">
            {% if not request.GET.q %}
                <div>
                    {% include 'tweets/form.html' with form=create_form action_url=create_url btn_title='Tweet' form_id='tweet-form' %}
                </div>
                <hr>
            {% endif %}

            <div id="tweet-container"></div>
        </div>
    </div>
{% endblock %}

{% block script %}
    <script>

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        $(document).ready(function () {

            let query = getParameterByName('q');
            let tweetList = [];
            
            function parseTweets() {
                if (tweetList == 0) {
                    $('#tweet-container').text(`No tweets currently found.`);
                } else {
                    $.each(tweetList, function (key, value) {
                    let tweetKey = key;
                    let tweetUser = value.user;
                    let tweetContent = value.content;
                    $('#tweet-container').append(`
                        <div class="media">
                            <div class="media-body">
                                ${tweetContent}<br>
                                via ${tweetUser.username} | <a href="#">View</a>
                            </div>
                        </div>
                        <hr>`
                    );
                });
                }
            }

            function fetchTweets() {
                $.ajax({
                    url: '/api/tweet/',
                    method: 'GET',
                    data: {
                        'q': query
                    },
                    success: function (data) {
                        tweetList = data;
                        parseTweets();
                    },
                    error: function (data) {
                        console.log('error');
                        console.log(data);
                    }
                });
            }

            fetchTweets();

            $('#tweet-form').submit(function (event) {
                event.preventDefault();
                let this_ = $(this);
                let formData = this_.serialize();
                $.ajax({
                    url: '/api/tweet/create/',
                    method: 'POST',
                    data: formData,
                    success: function (data) {
                        fetchTweets();
                    },
                    error: function (data) {
                        console.log('error');
                        console.log(data.statusText);
                        console.log(data.status);
                    }
                });
            });
        });
    </script>

{% endblock %}